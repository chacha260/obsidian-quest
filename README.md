# ⚔️ Obsidian Quest

**Obsidian での執筆活動を「冒険」に変える、ゲーミフィケーション・プラグイン。**

Obsidian Quest は、ライティング、知識整理、タスク消化を RPG のステータス（経験値）に変換します。**「どう書いたか」によって異なるキャラクターが成長するパーティ制システム**と、**画面上を動き回るデスクトップマスコット機能**を搭載しています。

---

## 🗺️ 概要

ユーザーの行動（執筆、コピペ、リンク作成、タスク完了）に応じて、4 人の RPG キャラクターがレベルアップします。さらに、キャラクターたちが画面上を自由に動き回り、クリックやドラッグで遊べる「Wandering Party（デスクトップペット）」機能を搭載しています。

---

## 👥 パーティ・システム (The Party)

アクションの種類によって経験値が入るキャラクターが異なります。

| キャラクター         | アイコン | 役割     | 成長トリガー         | XP 獲得量    |  実装状況   |
| :------------------- | :------: | :------- | :------------------- | :----------- | :---------: |
| **勇者 (Hero)**      |    ⚔️    | **執筆** | 1 文字ずつの入力     | 1 XP/文字    | ✅ 実装済み |
| **遊び人 (Playboy)** |    🍷    | **引用** | テキストのペースト   | 1 XP/文字    | ✅ 実装済み |
| **賢者 (Scholar)**   |    📖    | **連結** | リンク作成 `[[...]]` | 10 XP/リンク | ✅ 実装済み |
| **狩人 (Hunter)**    |    🏹    | **達成** | タスク完了 `- [x]`   | 20 XP/タスク | ✅ 実装済み |

**意味合い:**

- **勇者**: 努力の証。地道にキーボードを叩いた量。
- **遊び人**: 情報収集力。外部からリソースを持ち込んだ量。
- **賢者**: 知識の結合。脳内ネットワークの広がり。
- **狩人**: 実行力。完了させたタスクの数。

---

## 🎮 実装済み機能

### 1. **リアルタイム XP 取得**

エディタでの操作を監視し、即座に経験値を計算してキャラクターを成長させます。

### 2. **レベルアップ通知**

閾値を超えると、派手なトースト通知で祝福します。

### 3. **ステータス画面 (Ribbon UI)**

- サイドバーの「剣アイコン」から呼び出し。
- **DiceBear API** を利用したドット絵アバターの自動生成（Mochi、Coco、Vanilla、Choco のかわいいシード使用）。
- 現在のレベルと次のレベルまでのプログレスバー表示。

### 4. **Wandering Party (デスクトップペット) 🆕**

- **画面内をランダムに移動**: キャラクターたちが 5 秒ごとに画面内の別の位置へ移動します。
- **ドラッグ＆ドロップ**: マウスで掴んで好きな場所に配置できます。
- **クリックリアクション**: クリックするとジャンプアニメーションと吹き出しメッセージが表示されます。
- **カスタマイズ可能**: 設定から移動頻度と移動距離を調整できます。

### 5. **設定画面 🆕**

- **Wandering Interval（移動頻度）**: キャラクターが移動する間隔を秒単位で設定（デフォルト: 5 秒）。
- **Wandering Distance（移動距離）**: 移動時の最大距離をピクセル単位で設定（0 なら画面全体、100 なら現在地から 100px 以内など）。

---

## 🛠️ 技術スタックと実装ポイント

自作プラグインとして拡張性を重視した設計になっています。

- **Framework:** Obsidian API (TypeScript)
- **UI:** Vanilla JS + CSS Grid Layout (ステータス画面)
- **Assets:** DiceBear Pixel Art API (アバター生成)
- **Data Persistence:** `data.json` への自動保存
- **Animation:** CSS Transitions + JavaScript

### 判定ロジックのキモ

#### 文字数判定 (勇者 vs 遊び人)

`editor-change` イベントをフックし、変更前後の文字数差分 (`diff`) を計算:

```typescript
if (diff === 1) {
  // タイピング (勇者のXP)
} else if (diff > 1) {
  // ペースト (遊び人のXP)
}
```

#### WikiLink 判定 (賢者)

正規表現 `/\[\[.*?\]\]/g` で `[[...]]` の数をカウントし、増加分を XP に変換。

#### タスク完了判定 (狩人)

正規表現 `/- \[x\]/g` で `- [x]` の数をカウントし、増加分を XP に変換。

---

## 📂 ファイル構成

```text
obsidian-quest/
├── main.ts           # ロジック中枢 (Party System, Wandering Party, Settings)
├── styles.css        # UIデザイン (Status Screen, Desktop Pet)
├── manifest.json     # プラグイン定義 (ID: obsidian-quest)
├── package.json      # 依存関係
├── tsconfig.json     # TypeScript設定
├── esbuild.config.mjs # ビルド設定
└── README.md         # 本ドキュメント (開発者向け)
```

### 主要クラス構成

- **`ObsidianQuest`**: プラグイン本体。エディタイベント監視、XP 計算、設定管理。
- **`StatusModal`**: ステータス画面を表示するモーダルクラス。
- **`WanderingParty`**: デスクトップペット機能を管理するクラス。DOM 操作、タイマー、インタラクション処理。
- **`ObsidianQuestSettingTab`**: 設定画面の UI。

---

## 🚀 ロードマップ

### Phase 1: MVP ✅ **完了**

- [x] 勇者・遊び人の判定ロジック
- [x] 基本的なレベルアップ計算
- [x] ステータス画面の UI 実装
- [x] ドット絵の表示

### Phase 2: キャラクター拡張 ✅ **完了**

- [x] 賢者のロジック（WikiLink 作成で XP 獲得）
- [x] 狩人のロジック（チェックボックス完了で XP 獲得）

### Phase 3: Wandering Party ✅ **完了**

- [x] 画面内ランダム移動機能
- [x] ドラッグ＆ドロップインタラクション
- [x] クリックリアクション（ジャンプアニメーション）
- [x] 設定画面によるカスタマイズ（移動頻度・距離）

### Phase 4: 今後の拡張予定 🚧

以下は将来的に実装予定の機能アイデアです。

#### 🎮 Advanced Gamification

- **クラス進化**: レベル 10 到達でクラスチェンジ（勇者 → 勇者王、賢者 → 大賢者など）。
- **ボスバトル**: 大規模ファイル（5000 字以上）を「ボス」扱いし、完成時に特別報酬。
- **パーティコンボ**: 5 分以内に複数の行動（執筆+リンク+タスク完了）でコンボボーナス。

#### 🏆 Achievements & Rewards

- **アイテムドロップ**: 特定キーワード（「完了」「解決」など）でアイテム獲得し、一時的に XP ブースト。
- **デイリークエスト**: ランダムな日次チャレンジ（「500 字書く」など）。
- **連続ログインボーナス**: 毎日書くことでストリークボーナス。

#### 🎨 Visuals & Immersion

- **クリティカルヒット**: ランダムで入力時に 2 倍 XP 獲得エフェクト。
- **効果音**: レベルアップ時にレトロ RPG 風 SE（オプション設定可能）。
- **テーマ統合**: Obsidian のテーマに合わせて RPG テーマ変更（ファンタジー/SF/サイバーパンク）。

#### 🏰 Dungeon Mode (Major Feature)

- **リボンから起動**: 2D 迷路マップビューをリボンから起動。
- **探索機能**: 自動生成または固定マップをパーティで探索。
- **戦闘＆ルート**: 敵との遭遇で XP・アイテム・装備獲得（「迅速のキーボード」など）。
- **パーティ表示**: ダンジョン内でパーティスプライトが行進。

#### 🚶 Wandering Party 拡張

- **アニメーション強化**: GIF または CSS Animation でウォーク・アイドル・攻撃モーション。
- **カーソル追従モード**: カーソルの近くをついて歩く設定。
- **ステータスバー常駐**: ステータスバーに「座る」「寝る」アニメーション。

---

## 📦 開発環境のセットアップ

### 1. 依存関係のインストール

```bash
npm install
```

### 2. 開発ビルド (監視モード)

```bash
npm run dev
```

### 3. 本番ビルド

```bash
npm run build
```

### 4. プラグインのインストール（テスト用）

1. ビルド後、`main.js`、`manifest.json`、`styles.css` を以下にコピー:
   ```
   <Vault>/.obsidian/plugins/obsidian-quest/
   ```
2. Obsidian を再起動し、「設定 → コミュニティプラグイン」で有効化。

---

## 🤝 AI 開発者への引き継ぎ情報

このプラグインは、AI（Antigravity など）との共同開発を前提に設計されています。

### 現在の実装状況（2024 年 12 月時点）

- ✅ 4 キャラクター（勇者、遊び人、賢者、狩人）のロジック完成。
- ✅ Wandering Party（デスクトップペット）機能完成。
- ✅ 設定画面による移動頻度・距離のカスタマイズ。
- ✅ DiceBear API によるかわいいピクセルアートアバター。

### 次のステップ候補

- **ダンジョンモード**: 2D マップ生成＋戦闘システムの実装。
- **アニメーション強化**: GIF スプライトまたは CSS Animation でキャラモーション追加。
- **アイテムシステム**: 装備・消費アイテムの実装。
- **デイリークエスト**: ランダムチャレンジ生成ロジック。

### コード構造のポイント

- **`main.ts`**: すべてのロジックが単一ファイルに集約されています。今後の拡張時は、`src/`ディレクトリを作成してモジュール分割を推奨します。
- **設定の永続化**: `ObsidianQuestSettings`インターフェースに新しい設定を追加し、`DEFAULT_SETTINGS`に初期値を設定すれば自動で保存されます。
- **Wandering Party**: `WanderingParty`クラスが独立しているため、拡張しやすい設計です。

---

## 📜 License

MIT License

---

**さあ、ペン（キーボード）を取れ。冒険の始まりだ！**
